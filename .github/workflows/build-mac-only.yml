name: Build Mac Installer (Add to Existing Release)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          cd backend
          pip install --upgrade pip setuptools wheel

          # Remove pygooglenews (requires old feedparser that won't build)
          # App works fine without it - just loses one news source
          sed '/pygooglenews/d' requirements.txt > requirements-mac.txt

          # Install feedparser 6.x (modern, builds properly)
          pip install 'feedparser>=6.0.0'

          # Install the rest of requirements
          pip install -r requirements-mac.txt
          pip install pyinstaller

      - name: Initialize database
        run: |
          cd backend
          # Create .env file for database initialization
          cp .env.example .env 2>/dev/null || echo "SECRET_KEY=build-key-not-for-production" > .env
          # Create empty database by importing database module
          python -c "from database import engine, Base; Base.metadata.create_all(bind=engine); print('Database created')"

      - name: Build backend with PyInstaller
        run: |
          cd backend
          pyinstaller certify_backend.spec --clean --noconfirm

      - name: Verify backend build
        run: |
          if [ -f "backend/dist/certify_backend" ]; then
            echo "Backend build successful!"
            ls -la backend/dist/certify_backend
          else
            echo "Backend build failed - executable not found"
            exit 1
          fi

      - name: Prepare desktop app
        run: |
          mkdir -p desktop-app/backend-bundle
          mkdir -p desktop-app/frontend
          mkdir -p desktop-app/data

          cp backend/dist/certify_backend desktop-app/backend-bundle/

          if [ -f "backend/certify_intel.db" ]; then
            cp backend/certify_intel.db desktop-app/backend-bundle/
          fi

          if [ -f "backend/.env.example" ]; then
            cp backend/.env.example desktop-app/backend-bundle/.env
          fi

          cp -r frontend/* desktop-app/frontend/

      - name: Create Mac icon from PNG
        run: |
          cd desktop-app/resources/icons
          # Create iconset directory
          mkdir -p icon.iconset
          # Generate all required icon sizes from PNG
          sips -z 16 16     icon.png --out icon.iconset/icon_16x16.png
          sips -z 32 32     icon.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     icon.png --out icon.iconset/icon_32x32.png
          sips -z 64 64     icon.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   icon.png --out icon.iconset/icon_128x128.png
          sips -z 256 256   icon.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   icon.png --out icon.iconset/icon_256x256.png
          sips -z 512 512   icon.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   icon.png --out icon.iconset/icon_512x512.png
          sips -z 1024 1024 icon.png --out icon.iconset/icon_512x512@2x.png
          # Convert iconset to icns
          iconutil -c icns icon.iconset
          rm -rf icon.iconset
          echo "Created icon.icns"
          ls -la

      - name: Install Node dependencies
        run: |
          cd desktop-app
          npm ci

      - name: Build macOS installer
        run: |
          cd desktop-app
          # Use --publish never to skip auto-publish (manual upload has better control)
          # We upload to release manually in the next step
          npx electron-builder --mac --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List build output
        run: |
          echo "Build output:"
          ls -la desktop-app/dist/*.dmg

      - name: Upload to existing v5.1.2 release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v5.1.2
          files: desktop-app/dist/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Mac Installer Added to Release v5.1.2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following files were uploaded:" >> $GITHUB_STEP_SUMMARY
          ls -la desktop-app/dist/*.dmg >> $GITHUB_STEP_SUMMARY
